<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="eventTitle">Event Details</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Minimal inline styles - inherit theme from style.css for consistency */
    #event-photo img {
      width: 100%;
      height: auto;
      max-width: 100%;
      object-fit: contain; /* Full image without cropping */
      border-radius: 8px;
    }
    .event-details {
      margin: 1rem 0;
    }
    .program-list {
      list-style-type: disc;
      padding-left: 1.5rem;
    }
    .artists {
      font-style: italic;
    }
    .tickets-cta {
      background: #007bff;
      color: white;
      padding: 0.5rem 1rem;
      text-decoration: none;
      border-radius: 4px;
      display: inline-block;
      margin: 0.5rem 0;
    }
    .tickets-cta:hover {
      background: #0056b3;
    }
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 1rem;
    }
    .error {
      color: #d00;
      background: #fee;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    /* Carousel styles for event videos */
    .event-carousel {
      position: relative;
      max-width: 100%;
      margin: 1rem 0;
      overflow: hidden;
      border-radius: 8px;
    }
    .event-carousel iframe {
      width: 100%;
      height: 315px;
      display: none; /* Hide all except active */
      border-radius: 8px;
    }
    .event-carousel iframe.active {
      display: block;
    }
    .event-carousel-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 10px;
      gap: 10px;
    }
    .event-carousel-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    .event-carousel-btn:hover {
      background: #0056b3;
    }
    .event-carousel-dots {
      display: flex;
      gap: 5px;
    }
    .event-carousel-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ccc;
      cursor: pointer;
      transition: background 0.3s;
    }
    .event-carousel-dot.active {
      background: #007bff;
    }
    @media (max-width: 768px) {
      .event-carousel iframe {
        height: 200px;
      }
    }
    /* Ensure links in text are styled consistently with main page */
    .event-details p a {
      color: #007bff;
      text-decoration: underline;
    }
    .event-details p a:hover {
      color: #0056b3;
    }
  </style>
</head>
<body>
  <!-- Header (matching main page structure for consistency) -->
  <header>
    <div class="header-container">
      <h1><a href="index.html">Oscar Castellino</a></h1>
      <p id="tagline"></p> <!-- Matches main page tagline -->
      <nav>
        <a href="index.html">Home</a>
        <a href="biography.html">Biography</a>
      </nav>
    </div>
  </header>

  <!-- Event Photo -->
  <section id="event-photo" class="loading">
    Loading photo...
  </section>

  <!-- Event Details -->
  <section id="event-details" class="loading">
    Loading event...
  </section>

  <!-- Footer (matching main page) -->
  <footer>
    <p id="footer">© 2025 Oscar Castellino. All rights reserved. Version: v2.5</p>
  </footer>

  <script>
    (async function() {
      console.log('Script started');

      // Get eventId from URL query param
      const urlParams = new URLSearchParams(window.location.search);
      const eventId = urlParams.get('id');
      console.log('Event ID from URL:', eventId);

      const detailsSection = document.getElementById('event-details');
      const photoSection = document.getElementById('event-photo');
      if (!eventId) {
        detailsSection.innerHTML = '<p>Event not found. <a href="index.html">Back to Home</a></p>';
        photoSection.innerHTML = '';
        console.log('No event ID provided');
        return;
      }

      // Reuse convertDriveUrl for photo if needed
      function convertDriveUrl(url) {
        if (url.includes('uc?export=view&id=')) return url;
        if (!url.includes('drive.google.com')) return url;
        const match = url.match(/\/file\/d\/([a-zA-Z0-9-_]+)/);
        return match ? `https://drive.google.com/uc?export=view&id=${match[1]}` : url;
      }

      // Improved function to convert URLs to clickable links then handle newlines
      function renderTextWithLinksAndNewlines(text) {
        if (!text) return text;
        // Step 1: Convert URLs to clickable links first (using regex that captures full URLs including periods)
        let formatted = text;
        const urlRegex = /https?:\/\/[^\s<>]+/g;
        formatted = formatted.replace(urlRegex, (url) => {
          // Trim trailing punctuation if not part of URL (e.g., .,?,! after URL)
          const cleanUrl = url.replace(/[.,?!;:\s]*$/, '');
          return `<a href="${cleanUrl}" target="_blank" rel="noopener">${cleanUrl}</a>`;
        });
        // Step 2: Replace newlines with <br> after links are processed (avoids interference)
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
      }

      // Carousel functionality for event videos
      function initEventCarousel(videos, containerId) {
        const carousel = document.getElementById(containerId);
        const dotsContainer = carousel.parentElement.querySelector('.event-carousel-dots');
        const prevBtn = carousel.parentElement.querySelector('.event-carousel-btn.prev');
        const nextBtn = carousel.parentElement.querySelector('.event-carousel-btn.next');
        let currentIndex = 0;
        let autoPlayInterval;

        // Create iframes and dots
        videos.forEach((videoUrl, index) => {
          const iframe = document.createElement('iframe');
          iframe.src = videoUrl;
          iframe.title = `Event Video ${index + 1}`;
          iframe.frameBorder = '0';
          iframe.allowFullscreen = true;
          carousel.appendChild(iframe);

          const dot = document.createElement('span');
          dot.className = `event-carousel-dot ${index === 0 ? 'active' : ''}`;
          dot.onclick = () => goToSlide(index);
          dotsContainer.appendChild(dot);
        });

        function showSlide(index) {
          const iframes = carousel.querySelectorAll('iframe');
          const dots = dotsContainer.querySelectorAll('.event-carousel-dot');
          iframes.forEach((iframe, i) => iframe.classList.toggle('active', i === index));
          dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
          currentIndex = index;
        }

        function goToSlide(index) {
          clearInterval(autoPlayInterval);
          showSlide(index);
          startAutoPlay();
        }

        function nextSlide() {
          const next = (currentIndex + 1) % videos.length;
          showSlide(next);
        }

        function prevSlide() {
          const prev = (currentIndex - 1 + videos.length) % videos.length;
          showSlide(prev);
        }

        function startAutoPlay() {
          autoPlayInterval = setInterval(nextSlide, 10000); // 10 seconds
        }

        // Event listeners
        nextBtn.onclick = nextSlide;
        prevBtn.onclick = prevSlide;
        carousel.addEventListener('mouseenter', () => clearInterval(autoPlayInterval));
        carousel.addEventListener('mouseleave', startAutoPlay);

        // Initial setup
        showSlide(0);
        startAutoPlay();
      }

      try {
        // Fetch with timeout (5 seconds)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch('data.json', { signal: controller.signal });
        clearTimeout(timeoutId);

        console.log('Fetch response received:', response.ok ? 'Success' : 'Failed');
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data = await response.json();

        console.log('Data loaded, events count:', data.upcomingEvents.length);
        const event = data.upcomingEvents.find(e => e.eventId === eventId);
        console.log('Matched event:', event ? event.event : 'Not found');

        if (!event) {
          detailsSection.innerHTML = '<p class="error">Event not found. <a href="index.html">Back to Home</a></p>';
          photoSection.innerHTML = '';
          return;
        }

        // Populate page
        document.title = `${event.event} | Oscar Castellino`;
        detailsSection.classList.remove('loading');
        detailsSection.innerHTML = `<h1>${event.event}</h1>`;

        // Overview (from information)
        if (event.information) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Overview</h3>
              <p>${renderTextWithLinksAndNewlines(event.information)}</p>
            </div>
          `;
        }

        // Description (dedicated section) - only render if `event.description` exists
        if (event.description) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Description</h3>
              <p>${renderTextWithLinksAndNewlines(event.description)}</p>
            </div>
          `;
        }

        // Date & Time (if present)
        if (event.date || event.time) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Date & Time</h3>
              <p>${event.date || ''}${event.time ? '<br>' + renderTextWithLinksAndNewlines(event.time) : ''}</p>
            </div>
          `;
        }

        // Venue & Address (if present)
        if (event.venue || event.address) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Venue</h3>
              <p><strong>${event.venue || ''}</strong>${event.address ? '<br>' + renderTextWithLinksAndNewlines(event.address) : ''}</p>
            </div>
          `;
        }

        // Artists (if present)
        if (event.artists) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Artists</h3>
              <p class="artists">${Array.isArray(event.artists) ? event.artists.join(', ') : event.artists}</p>
            </div>
          `;
        }

        // Program (if present)
        if (event.program && event.program.length > 0) {
          const programHtml = event.program.map(item => `<li>${item}</li>`).join('');
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Program</h3>
              <ul class="program-list">${programHtml}</ul>
            </div>
          `;
        }

        // Videos Carousel (if present, for internal events)
        if (event.videos && event.videos.length > 0) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Videos</h3>
              <div class="event-carousel" id="eventVideoCarousel"></div>
              <div class="event-carousel-nav">
                <button class="event-carousel-btn prev">&lt;</button>
                <div class="event-carousel-dots"></div>
                <button class="event-carousel-btn next">&gt;</button>
              </div>
            </div>
          `;
          // Initialize after DOM update
          setTimeout(() => initEventCarousel(event.videos, 'eventVideoCarousel'), 0);
        }

        // Tickets (use bookingLink as fallback)
        // Only render the Tickets section when there is meaningful ticket information available.
        const hasTicketsObject = !!event.tickets && (event.tickets.price || event.tickets.link);
        const hasBookingLink = !!event.bookingLink;
        if (hasTicketsObject || hasBookingLink) {
          const ticketsPrice = event.tickets && event.tickets.price ? event.tickets.price : 'TBD';
          let ticketsLinkHtml = '';
          const ticketsLink = event.tickets && event.tickets.link ? event.tickets.link : event.bookingLink;
          if (ticketsLink) {
            ticketsLinkHtml = `<a href="${ticketsLink.startsWith('http') ? ticketsLink : 'https://' + ticketsLink}" class="tickets-cta" target="_blank">Buy Tickets</a>`;
          }
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Tickets</h3>
              <p>${renderTextWithLinksAndNewlines(ticketsPrice)}</p>
              ${ticketsLinkHtml}
            </div>
          `;
        } else {
          // No ticket info — don't render Tickets heading or section.
          console.log('No ticket information for this event, skipping Tickets section');
        }

        // Contact Info (if present)
        if (event.contactInfo) {
          detailsSection.innerHTML += `
            <div class="event-details">
              <h3>Additional Info</h3>
              <p>${renderTextWithLinksAndNewlines(event.contactInfo)}</p>
            </div>
          `;
        }

        // Display media (new): either an image filename/URL or a YouTube link.
        // Backwards compatible with `photo` field.
        function convertYouTubeToEmbed(url) {
          try {
            if (!url) return null;
            // Already an embed URL
            if (url.includes('youtube.com/embed')) return url;
            const u = new URL(url);
            // youtu.be short link
            if (u.hostname.includes('youtu.be')) {
              const id = u.pathname.slice(1);
              return `https://www.youtube.com/embed/${id}${u.search || ''}`;
            }
            // youtube.com links
            if (u.hostname.includes('youtube.com')) {
              if (u.pathname === '/watch') {
                const vid = u.searchParams.get('v');
                const si = u.searchParams.get('si');
                return `https://www.youtube.com/embed/${vid}${si ? '?si=' + si : ''}`;
              }
              // shorts or other formats
              const parts = u.pathname.split('/');
              const shortsIdx = parts.indexOf('shorts');
              if (shortsIdx >= 0 && parts[shortsIdx + 1]) {
                return `https://www.youtube.com/embed/${parts[shortsIdx + 1]}`;
              }
            }
          } catch (e) {
            console.warn('Invalid media URL', url, e);
          }
          return null;
        }

        photoSection.classList.remove('loading');
        const display = event.displayMedia || event.photo; // prefer new field, fallback to legacy
        if (display) {
          // If it's an HTTP URL and appears to be YouTube, render iframe
          if (display.startsWith('http') && (display.includes('youtube.com') || display.includes('youtu.be'))) {
            const embed = convertYouTubeToEmbed(display);
            if (embed) {
              photoSection.innerHTML = `<iframe src="${embed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="${event.event} Video" style="width:100%;height:360px;border-radius:8px"></iframe>`;
            } else {
              // Fallback: show the link
              photoSection.innerHTML = `<p><a href="${display}" target="_blank">Open media</a></p>`;
            }
          } else {
            // Treat as an image filename or non-YouTube URL
            let mediaUrl = display;
            if (mediaUrl.startsWith('http')) {
              mediaUrl = convertDriveUrl(mediaUrl);
            } else {
              mediaUrl = `pictures/${mediaUrl}`;
            }
            console.log('Media URL:', mediaUrl);
            const img = document.createElement('img');
            img.src = mediaUrl;
            img.alt = `${event.event} Photo`;
            img.onload = () => console.log('Media loaded successfully');
            img.onerror = () => {
              console.error('Media load failed');
              photoSection.innerHTML = '<p>No photo available.</p>';
            };
            photoSection.innerHTML = '';
            photoSection.appendChild(img);
          }
        } else {
          photoSection.innerHTML = '<p>No photo available.</p>';
        }
      } catch (error) {
        console.error('Fetch error:', error);
        detailsSection.innerHTML = `<p class="error">Error loading event: ${error.message}. <a href="index.html">Back to Home</a></p>`;
        photoSection.innerHTML = '';
      }
    })();
  </script>
</body>
</html>
